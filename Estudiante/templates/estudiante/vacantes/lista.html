{% extends 'estudiante/base.html' %}

{% block title %}Vacantes Disponibles - Portal Estudiantes{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark navbar-estudiante">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'estudiante:dashboard' %}">
            <i class="fas fa-user-graduate me-2"></i>
            Portal Estudiantes
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'estudiante:dashboard' %}">
                        <i class="fas fa-home me-1"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                        {% if estudiante_actual.foto_perfil %}
                            <img src="{{ estudiante_actual.foto_perfil.url }}" 
                                 alt="{{ estudiante_actual.nombre_completo }}"
                                 class="rounded-circle me-2"
                                 style="width: 32px; height: 32px; object-fit: cover; border: 2px solid white;">
                        {% else %}
                            <i class="fas fa-user-circle me-2" style="font-size: 1.5rem;"></i>
                        {% endif %}
                        {{ estudiante_actual.nombre_completo|default:user.username }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="{% url 'estudiante:perfil' %}">
                                <i class="fas fa-user-edit me-2"></i>Mi Perfil
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="{% url 'estudiante:logout' %}">
                                <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar">
            <div class="list-group">
                <a href="{% url 'estudiante:dashboard' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-home me-2"></i>Dashboard
                </a>
                <a href="{% url 'estudiante:vacantes_lista' %}" class="list-group-item list-group-item-action active">
                    <i class="fas fa-briefcase me-2"></i>Vacantes Disponibles
                </a>
                <a href="{% url 'estudiante:postulaciones_lista' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-clipboard-list me-2"></i>Mis Postulaciones
                </a>
                <a href="{% url 'estudiante:mi_practica' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-building me-2"></i>Mi Práctica
                </a>
                <a href="{% url 'estudiante:mis_seguimientos' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-calendar-check me-2"></i>Seguimientos Semanales
                </a>
                <a href="{% url 'estudiante:mi_docente_asesor' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-chalkboard-teacher me-2"></i>Mi Docente Asesor
                </a>
            </div>
        </div>

        <!-- Main Area -->
        <div class="col-md-9 col-lg-10">
            <div id="vacantes-react-root"></div>
        </div>
    </div>
</div>

<script type="text/babel">
    const { useState, useEffect } = React;

    function VacantesApp() {
        const vacantesData = {{ vacantes|safe }};
        const programaEstudiante = "{{ estudiante_programa }}";
        const [vacantes, setVacantes] = useState(vacantesData);
        const [filtroPrograma, setFiltroPrograma] = useState("{{ programa_filtro }}");
        const [busqueda, setBusqueda] = useState("{{ buscar }}");

        // Filtrar vacantes localmente
        const filtrarVacantes = () => {
            let resultado = vacantesData;

            if (filtroPrograma === 'mi_programa') {
                resultado = resultado.filter(v => 
                    v.programa_academico.toLowerCase().includes(programaEstudiante.toLowerCase())
                );
            }

            if (busqueda) {
                resultado = resultado.filter(v =>
                    v.titulo.toLowerCase().includes(busqueda.toLowerCase()) ||
                    v.area_practica.toLowerCase().includes(busqueda.toLowerCase()) ||
                    v.empresa.razon_social.toLowerCase().includes(busqueda.toLowerCase())
                );
            }

            setVacantes(resultado);
        };

        useEffect(() => {
            filtrarVacantes();
        }, [filtroPrograma, busqueda]);

        return (
            <div>
                {/* Header */}
                <div className="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2>
                            <i className="fas fa-briefcase me-2 text-primary"></i>
                            Vacantes Disponibles
                        </h2>
                        <p className="text-muted mb-0">
                            Explora las oportunidades de práctica empresarial
                        </p>
                    </div>
                    <div>
                        <span className="badge bg-success fs-6">
                            {vacantes.length} vacante{vacantes.length !== 1 ? 's' : ''} disponible{vacantes.length !== 1 ? 's' : ''}
                        </span>
                    </div>
                </div>

                {/* Alerta Informativa */}
                <div className="alert alert-info border-start border-5 border-info mb-4" role="alert">
                    <h5 className="alert-heading">
                        <i className="fas fa-info-circle me-2"></i>
                        Importante
                    </h5>
                    <p className="mb-0">
                        Estas vacantes son solo para consulta.
                        <strong>La Coordinación Empresarial</strong> es quien realiza las postulaciones oficiales 
                        después de evaluar tu perfil y la compatibilidad con las empresas.
                    </p>
                </div>

                {/* Filtros */}
                <FiltrosVacantes 
                    filtroPrograma={filtroPrograma}
                    setFiltroPrograma={setFiltroPrograma}
                    busqueda={busqueda}
                    setBusqueda={setBusqueda}
                    programaEstudiante={programaEstudiante}
                />

                {/* Lista de Vacantes */}
                {vacantes.length > 0 ? (
                    <div className="row g-4">
                        {vacantes.map(vacante => (
                            <VacanteCard key={vacante.id} vacante={vacante} />
                        ))}
                    </div>
                ) : (
                    <div className="alert alert-warning text-center py-5">
                        <i className="fas fa-search fa-3x mb-3 text-muted"></i>
                        <h4>No se encontraron vacantes</h4>
                        <p className="mb-0">
                            Intenta ajustar los filtros de búsqueda
                        </p>
                    </div>
                )}
            </div>
        );
    }

    // ==========================================
    // COMPONENTE: Filtros
    // ==========================================
    function FiltrosVacantes({ filtroPrograma, setFiltroPrograma, busqueda, setBusqueda, programaEstudiante }) {
        return (
            <div className="card mb-4">
                <div className="card-body">
                    <div className="row g-3">
                        <div className="col-md-6">
                            <label className="form-label fw-bold">
                                <i className="fas fa-filter me-2"></i>Filtrar por Programa
                            </label>
                            <select 
                                className="form-select"
                                value={filtroPrograma}
                                onChange={(e) => setFiltroPrograma(e.target.value)}
                            >
                                <option value="">Todos los programas</option>
                                <option value="mi_programa">
                                    Mi programa ({programaEstudiante})
                                </option>
                            </select>
                        </div>

                        <div className="col-md-6">
                            <label className="form-label fw-bold">
                                <i className="fas fa-search me-2"></i>Buscar
                            </label>
                            <input
                                type="text"
                                className="form-control"
                                placeholder="Buscar por título, empresa o área..."
                                value={busqueda}
                                onChange={(e) => setBusqueda(e.target.value)}
                            />
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // COMPONENTE: Card de Vacante
    // ==========================================
    function VacanteCard({ vacante }) {
        return (
            <div className="col-md-6 col-lg-4">
                <div className="card h-100 hover-shadow">
                    <div className="card-body d-flex flex-column">
                        {/* Empresa y Estado */}
                        <div className="d-flex justify-content-between align-items-start mb-3">
                            <div className="flex-grow-1">
                                <h6 className="text-muted mb-1 small">
                                    <i className="fas fa-building me-1"></i>
                                    {vacante.empresa.razon_social}
                                </h6>
                            </div>
                            {vacante.ya_postulado && (
                                <span className="badge bg-info">
                                    <i className="fas fa-check me-1"></i>Postulado
                                </span>
                            )}
                        </div>

                        {/* Título */}
                        <h5 className="card-title mb-3">
                            {vacante.titulo}
                        </h5>

                        {/* Área */}
                        <p className="text-muted small mb-2">
                            <i className="fas fa-briefcase me-2 text-success"></i>
                            <strong>Área:</strong> {vacante.area_practica}
                        </p>

                        {/* Programa */}
                        <p className="text-muted small mb-2">
                            <i className="fas fa-graduation-cap me-2 text-primary"></i>
                            <strong>Programa:</strong> {vacante.programa_academico}
                        </p>

                        {/* Semestre Mínimo */}
                        <p className="text-muted small mb-2">
                            <i className="fas fa-calendar-alt me-2 text-warning"></i>
                            <strong>Semestre mínimo:</strong> {vacante.semestre_minimo}°
                        </p>

                        {/* Duración */}
                        <p className="text-muted small mb-3">
                            <i className="fas fa-clock me-2 text-info"></i>
                            <strong>Duración:</strong> {vacante.duracion_meses} meses
                        </p>

                        {/* Indicador de Requisitos */}
                        {vacante.cumple_requisitos ? (
                            <div className="alert alert-success py-2 px-3 mb-3 small">
                                <i className="fas fa-check-circle me-2"></i>
                                Cumples los requisitos
                            </div>
                        ) : (
                            <div className="alert alert-warning py-2 px-3 mb-3 small">
                                <i className="fas fa-exclamation-triangle me-2"></i>
                                No cumples todos los requisitos
                            </div>
                        )}

                        {/* Footer con Cupos y Botón */}
                        <div className="mt-auto">
                            <div className="d-flex justify-content-between align-items-center">
                                <span className="badge bg-primary">
                                    {vacante.cupos_disponibles} cupo{vacante.cupos_disponibles !== 1 ? 's' : ''}
                                </span>
                                <a 
                                    href={`{% url 'estudiante:vacante_detalle' 0 %}`.replace('0', vacante.id)}
                                    className="btn btn-sm btn-outline-primary"
                                >
                                    Ver Detalle <i className="fas fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // Renderizar
    const root = ReactDOM.createRoot(document.getElementById('vacantes-react-root'));
    root.render(<VacantesApp />);
</script>

<style>
    .hover-shadow {
        transition: all 0.3s ease;
    }

    .hover-shadow:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

