{% extends 'estudiante/base.html' %}

{% block title %}Mi Dashboard - Portal Estudiantes{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark navbar-estudiante">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'estudiante:dashboard' %}">
            <i class="fas fa-user-graduate me-2"></i>
            Portal Estudiantes
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                        {% if estudiante_actual.foto_perfil %}
                            <img src="{{ estudiante_actual.foto_perfil.url }}" 
                                 alt="{{ estudiante_actual.nombre_completo }}"
                                 class="rounded-circle me-2"
                                 style="width: 32px; height: 32px; object-fit: cover; border: 2px solid white;">
                        {% else %}
                            <i class="fas fa-user-circle me-2" style="font-size: 1.5rem;"></i>
                        {% endif %}
                        {{ estudiante_actual.nombre_completo|default:user.username }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="{% url 'estudiante:perfil' %}">
                                <i class="fas fa-user-edit me-2"></i>Mi Perfil
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="{% url 'estudiante:logout' %}">
                                <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar">
            <div class="list-group">
                <a href="{% url 'estudiante:dashboard' %}" class="list-group-item list-group-item-action active">
                    <i class="fas fa-home me-2"></i>Dashboard
                </a>
                </a>
                <a href="{% url 'estudiante:postulaciones_lista' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-clipboard-list me-2"></i>Mis Postulaciones
                </a>
                <a href="{% url 'estudiante:mi_practica' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-building me-2"></i>Mi Práctica
                </a>
                <a href="{% url 'estudiante:mis_seguimientos' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-calendar-check me-2"></i>Seguimientos Semanales
                </a>
                <a href="{% url 'estudiante:mi_docente_asesor' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-chalkboard-teacher me-2"></i>Mi Docente Asesor
                </a>
            </div>
        </div>

        <!-- Main Dashboard Area (React) -->
        <div class="col-md-9 col-lg-10">
            <div id="dashboard-react-root"></div>
        </div>
    </div>
</div>

<script type="text/babel">
    const { useState, useEffect } = React;

    // URLs de Django pasadas a JavaScript
    const URLS = {
        noApto: "{% url 'estudiante:no_apto' %}",
        perfil: "{% url 'estudiante:perfil' %}",
        miPractica: "{% url 'estudiante:mi_practica' %}",
        postulacionesLista: "{% url 'estudiante:postulaciones_lista' %}",
        vacantesLista: "{% url 'estudiante:vacantes_lista' %}",
        postulacionDetalle: "{% url 'estudiante:postulacion_detalle' 0 %}",
        vacanteDetalle: "{% url 'estudiante:vacante_detalle' 0 %}"
    };

    function DashboardApp() {
        // Variables inyectadas desde Django (JSON seguros)
        const estudiante = JSON.parse('{{ estudiante_json|escapejs }}');
        const stats = JSON.parse('{{ stats|escapejs }}');
        const postulaciones = JSON.parse('{{ postulaciones|escapejs }}');
        const vacantes = JSON.parse('{{ vacantes|escapejs }}');
        {% if practica_actual %}
        const practicaActual = JSON.parse('{{ practica_actual|escapejs }}');
        {% else %}
        const practicaActual = null;
        {% endif %}

        return (
            <div>
                {/* Sección de Bienvenida */}
                <WelcomeSection estudiante={estudiante} stats={stats} />

                {/* Mostrar contenido según estado */}
                {stats.estado === 'NO_APTO' && <EstudianteNoAptoAlert estudiante={estudiante} />}
                {stats.estado === 'APTO' && <EstudianteAptoContent stats={stats} postulaciones={postulaciones} vacantes={vacantes} />}
                {stats.estado === 'EN_PRACTICA' && <EstudianteEnPracticaContent practicaActual={practicaActual} stats={stats} />}
                {stats.estado === 'FINALIZADO' && <EstudianteFinalizadoContent />}

                {/* Sección de Postulaciones Recientes (para todos) */}
                {postulaciones && postulaciones.length > 0 && stats.estado !== 'NO_APTO' && (
                    <PostulacionesRecientes postulaciones={postulaciones} />
                )}

                {/* Sección de Vacantes Disponibles (para APTO) */}
                {vacantes && vacantes.length > 0 && stats.estado === 'APTO' && (
                    <VacantesDisponibles vacantes={vacantes} estudiante={estudiante} />
                )}
            </div>
        );
    }

    // ==========================================
    // COMPONENTE: Sección de Bienvenida
    // ==========================================
    function WelcomeSection({ estudiante, stats }) {
        const getEstadoBadge = () => {
            const badges = {
                'APTO': { color: 'success', icon: 'check-circle', text: 'Apto para Prácticas' },
                'NO_APTO': { color: 'danger', icon: 'exclamation-circle', text: 'No Apto (Semestre Bajo)' },
                'EN_PRACTICA': { color: 'info', icon: 'tasks', text: 'En Práctica' },
                'FINALIZADO': { color: 'secondary', icon: 'flag-checkered', text: 'Práctica Finalizada' }
            };
            const badge = badges[stats.estado] || badges['APTO'];
            return (
                <span className={`badge badge-estado badge-${badge.color} ms-3`}>
                    <i className={`fas fa-${badge.icon} me-2`}></i>
                    {badge.text}
                </span>
            );
        };

        return (
            <div className="welcome-section mb-4">
                <div className="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 className="display-5">
                            <i className="fas fa-hand-wave me-2 text-warning"></i>
                            ¡Hola, {estudiante.nombre_completo}!
                        </h1>
                        <p className="lead text-muted mb-0">
                            {estudiante.programa_academico} - {estudiante.semestre}° Semestre
                            {getEstadoBadge()}
                        </p>
                    </div>
                    <div className="text-end">
                        <p className="mb-1 text-muted">
                            <i className="fas fa-id-card me-2"></i>
                            Código: <strong>{estudiante.codigo}</strong>
                        </p>
                        {estudiante.promedio_academico && (
                            <p className="mb-0 text-muted">
                                <i className="fas fa-chart-line me-2"></i>
                                Promedio: <strong>{estudiante.promedio_academico}</strong>
                            </p>
                        )}
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // COMPONENTE: Alerta para NO APTO
    // ==========================================
    function EstudianteNoAptoAlert({ estudiante }) {
        const semestresRestantes = 4 - estudiante.semestre;
        
        return (
            <div className="alert alert-warning border-start border-5 border-warning" role="alert">
                <h4 className="alert-heading">
                    <i className="fas fa-info-circle me-2"></i>
                    Aún no puedes realizar prácticas
                </h4>
                <p className="mb-2">
                    Actualmente estás en <strong>{estudiante.semestre}° semestre</strong>. 
                    Las prácticas empresariales están disponibles a partir de <strong>4to semestre</strong>.
                </p>
                <p className="mb-0">
                    <i className="fas fa-calendar-alt me-2"></i>
                    Te faltan <strong>{semestresRestantes} semestre{semestresRestantes !== 1 ? 's' : ''}</strong> para poder postularte a prácticas.
                </p>
                <hr />
                <p className="mb-0">
                    <a href={URLS.noApto} className="alert-link">
                        Ver más información sobre requisitos <i className="fas fa-arrow-right ms-1"></i>
                    </a>
                </p>
            </div>
        );
    }

    // ==========================================
    // COMPONENTE: Contenido para APTO
    // ==========================================
    function EstudianteAptoContent({ stats, postulaciones, vacantes }) {
        return (
            <>
                <div className="row g-4 mb-4">
                    <StatCard
                        icon="fa-clipboard-check"
                        title="Postulaciones Totales"
                        value={stats.postulaciones_total}
                        color="primary"
                    />
                    <StatCard
                        icon="fa-clock"
                        title="Postulaciones Activas"
                        value={stats.postulaciones_activas}
                        color="warning"
                    />
                    <StatCard
                        icon="fa-briefcase"
                        title="Vacantes Disponibles"
                        value={stats.vacantes_disponibles}
                        color="success"
                    />
                    <StatCard
                        icon={stats.tiene_hoja_vida ? "fa-file-pdf" : "fa-exclamation-triangle"}
                        title="Hoja de Vida"
                        value={stats.tiene_hoja_vida ? "Subida" : "Pendiente"}
                        color={stats.tiene_hoja_vida ? "info" : "danger"}
                    />
                </div>

                {!stats.tiene_hoja_vida && (
                    <div className="alert alert-info border-start border-5 border-info mb-4" role="alert">
                        <h5 className="alert-heading">
                            <i className="fas fa-info-circle me-2"></i>
                            Completa tu perfil
                        </h5>
                        <p className="mb-2">
                            Para mejorar tus oportunidades de ser postulado, te recomendamos subir tu hoja de vida.
                        </p>
                        <a href={URLS.perfil} className="btn btn-info btn-sm">
                            <i className="fas fa-upload me-2"></i>Subir Hoja de Vida
                        </a>
                    </div>
                )}
            </>
        );
    }

    // ==========================================
    // COMPONENTE: Contenido para EN_PRACTICA
    // ==========================================
    function EstudianteEnPracticaContent({ practicaActual, stats }) {
        if (!practicaActual) return null;

        return (
            <>
                <div className="alert alert-success border-start border-5 border-success mb-4" role="alert">
                    <h4 className="alert-heading">
                        <i className="fas fa-check-circle me-2"></i>
                        Práctica en Curso
                    </h4>
                    <p className="mb-2">
                        Estás realizando tu práctica en <strong>{practicaActual.empresa}</strong>
                    </p>
                    <a href={URLS.miPractica} className="btn btn-primary btn-sm">
                        <i className="fas fa-tasks me-2"></i>Ver Mi Práctica
                    </a>
                </div>

                <div className="row g-4 mb-4">
                    <StatCard
                        icon="fa-calendar-check"
                        title="Plan de Práctica"
                        value={stats.plan_aprobado ? "Aprobado" : "Pendiente"}
                        color={stats.plan_aprobado ? "success" : "warning"}
                    />
                    <StatCard
                        icon="fa-file-alt"
                        title="Seguimientos"
                        value={stats.seguimientos_realizados}
                        color="info"
                    />
                    <StatCard
                        icon="fa-graduation-cap"
                        title="Sustentación"
                        value={stats.sustentacion_programada ? "Programada" : "Pendiente"}
                        color={stats.sustentacion_programada ? "success" : "secondary"}
                    />
                    <StatCard
                        icon="fa-chalkboard-teacher"
                        title="Docente Asesor"
                        value={practicaActual.docente_asesor}
                        color="primary"
                        isText={true}
                    />
                </div>

                <div className="card mb-4">
                    <div className="card-header bg-success text-white">
                        <i className="fas fa-building me-2"></i>
                        Información de la Práctica
                    </div>
                    <div className="card-body">
                        <div className="row">
                            <div className="col-md-6 mb-3">
                                <p className="mb-1"><strong>Empresa:</strong></p>
                                <p className="text-muted mb-0">{practicaActual.empresa}</p>
                            </div>
                            <div className="col-md-6 mb-3">
                                <p className="mb-1"><strong>Tutor Empresarial:</strong></p>
                                <p className="text-muted mb-0">{practicaActual.tutor_empresarial}</p>
                            </div>
                            <div className="col-md-6 mb-3">
                                <p className="mb-1"><strong>Fecha de Inicio:</strong></p>
                                <p className="text-muted mb-0">
                                    <i className="fas fa-calendar me-2"></i>
                                    {new Date(practicaActual.fecha_inicio).toLocaleDateString('es-CO')}
                                </p>
                            </div>
                            <div className="col-md-6 mb-3">
                                <p className="mb-1"><strong>Fecha Estimada de Fin:</strong></p>
                                <p className="text-muted mb-0">
                                    <i className="fas fa-calendar-alt me-2"></i>
                                    {new Date(practicaActual.fecha_fin_estimada).toLocaleDateString('es-CO')}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </>
        );
    }

    // ==========================================
    // COMPONENTE: Contenido para FINALIZADO
    // ==========================================
    function EstudianteFinalizadoContent() {
        return (
            <div className="alert alert-secondary border-start border-5 border-secondary" role="alert">
                <h4 className="alert-heading">
                    <i className="fas fa-flag-checkered me-2"></i>
                    Práctica Finalizada
                </h4>
                <p className="mb-0">
                    ¡Felicitaciones! Has completado exitosamente tu práctica empresarial.
                </p>
            </div>
        );
    }

    // ==========================================
    // COMPONENTE: Tarjeta de Estadística
    // ==========================================
    function StatCard({ icon, title, value, color, isText = false }) {
        return (
            <div className="col-md-6 col-lg-3">
                <div className={`card stat-card border-${color}`}>
                    <div className="card-body">
                        <div className="d-flex justify-content-between align-items-center">
                            <div>
                                <p className="text-muted mb-1 small">{title}</p>
                                <h3 className={`text-${color} mb-0 ${isText ? 'h6' : ''}`}>
                                    {value}
                                </h3>
                            </div>
                            <div>
                                <i className={`fas ${icon} fa-2x text-${color} opacity-25`}></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // COMPONENTE: Postulaciones Recientes
    // ==========================================
    function PostulacionesRecientes({ postulaciones }) {
        const getEstadoBadge = (estado) => {
            const badges = {
                'POSTULADO': { color: 'primary', text: 'Postulado' },
                'SELECCIONADO': { color: 'success', text: 'Seleccionado' },
                'VINCULADO': { color: 'info', text: 'Vinculado' },
                'RECHAZADO': { color: 'danger', text: 'Rechazado' }
            };
            return badges[estado] || badges['POSTULADO'];
        };

        return (
            <div className="card mb-4">
                <div className="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span>
                        <i className="fas fa-clipboard-list me-2"></i>
                        Postulaciones Recientes
                    </span>
                    <a href={URLS.postulacionesLista} className="btn btn-sm btn-light">
                        Ver Todas <i className="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div className="card-body p-0">
                    <div className="table-responsive">
                        <table className="table table-hover mb-0">
                            <thead className="table-light">
                                <tr>
                                    <th>Vacante</th>
                                    <th>Empresa</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {postulaciones.map(postulacion => {
                                    const badge = getEstadoBadge(postulacion.estado);
                                    return (
                                        <tr key={postulacion.id}>
                                            <td>{postulacion.vacante.titulo}</td>
                                            <td>{postulacion.vacante.empresa}</td>
                                            <td>
                                                <span className={`badge bg-${badge.color}`}>
                                                    {badge.text}
                                                </span>
                                            </td>
                                            <td>
                                                {new Date(postulacion.fecha_postulacion).toLocaleDateString('es-CO')}
                                            </td>
                                            <td>
                                                <a 
                                                    href={URLS.postulacionDetalle.replace('0', postulacion.id)}
                                                    className="btn btn-sm btn-outline-primary"
                                                >
                                                    <i className="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );
    }

    // ==========================================
    // COMPONENTE: Vacantes Disponibles
    // ==========================================
    function VacantesDisponibles({ vacantes, estudiante }) {
        return (
            <div className="card">
                <div className="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span>
                        <i className="fas fa-briefcase me-2"></i>
                        Vacantes Disponibles para {estudiante.programa_academico}
                    </span>
                    <a href={URLS.vacantesLista} className="btn btn-sm btn-light">
                        Ver todas <i className="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div className="card-body">
                    <div className="row g-3">
                        {vacantes.map(vacante => (
                            <div key={vacante.id} className="col-md-6 col-lg-4">
                                <div className="card h-100">
                                    <div className="card-body">
                                        <h6 className="card-title text-truncate" title={vacante.titulo}>
                                            {vacante.titulo}
                                        </h6>
                                        <p className="card-text small text-muted mb-2">
                                            <i className="fas fa-building me-2"></i>
                                            {vacante.empresa.razon_social}
                                        </p>
                                        <p className="card-text small text-muted mb-2">
                                            <i className="fas fa-map-marker-alt me-2"></i>
                                            {vacante.area_practica}
                                        </p>
                                        <div className="d-flex justify-content-between align-items-center mt-3">
                                            <span className="badge bg-primary">
                                                {vacante.cupos_disponibles} cupo{vacante.cupos_disponibles !== 1 ? 's' : ''}
                                            </span>
                                            <a 
                                                href={URLS.vacanteDetalle.replace('0', vacante.id)}
                                                className="btn btn-sm btn-outline-primary"
                                            >
                                                Ver más <i className="fas fa-arrow-right ms-1"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    }

    // Renderizar la aplicación React
    const root = ReactDOM.createRoot(document.getElementById('dashboard-react-root'));
    root.render(<DashboardApp />);
</script>
{% endblock %}